name: ğŸ›¡ï¸ FilterMapIR Daily Network Intelligence Scan

on:
  # Trigger on push to main (for code/web updates)
  push:
    branches:
      - "main"
    paths-ignore:
      - "reports/**"  # Avoid loops when bot commits reports
      - "README.md"
  
  # Scheduled daily runs
  schedule:
    - cron: '0 0 * * *'    # 00:00 UTC (03:30 Iran)
    - cron: '0 12 * * *'   # 12:00 UTC (15:30 Iran) - Second scan
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      enable_traceroute:
        description: 'ğŸ”€ Enable Traceroute Analysis'
        required: false
        type: boolean
        default: false
      deep_scan:
        description: 'ğŸ” Deep Scan Mode (More comprehensive but slower)'
        required: false
        type: boolean
        default: false
      custom_targets:
        description: 'ğŸ¯ Custom targets file (leave empty for default)'
        required: false
        type: string
        default: ''

# Permissions
permissions:
  contents: write
  pages: write
  id-token: write

# Concurrency - prevent multiple scans running simultaneously
concurrency:
  group: network-scan
  cancel-in-progress: false

env:
  SCAN_TIMEOUT: 3600  # 1 hour max
  REPORT_RETENTION_DAYS: 90

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Network Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  network-scan:
    name: ğŸ“¡ Network Intelligence Scan
    runs-on: windows-latest
    timeout-minutes: 60
    
    outputs:
      scan_date: ${{ steps.scan.outputs.scan_date }}
      pass_rate: ${{ steps.analyze.outputs.pass_rate }}
      total_targets: ${{ steps.analyze.outputs.total_targets }}
      blocked_count: ${{ steps.analyze.outputs.blocked_count }}
      scan_status: ${{ steps.analyze.outputs.scan_status }}
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # System Info
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ–¥ï¸ System Information
        id: sysinfo
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           FilterMapIR Network Intelligence Scanner               â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          $info = @{
            Hostname = $env:COMPUTERNAME
            OS = [System.Environment]::OSVersion.VersionString
            PowerShell = $PSVersionTable.PSVersion.ToString()
            DateTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
            RunId = "${{ github.run_id }}"
            RunNumber = "${{ github.run_number }}"
            Trigger = "${{ github.event_name }}"
          }
          
          Write-Host "â”Œâ”€ System Details" -ForegroundColor Yellow
          $info.GetEnumerator() | ForEach-Object {
            Write-Host "â”‚  $($_.Key): $($_.Value)" -ForegroundColor Gray
          }
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Yellow
          
          # Get runner public IP (for location detection)
          try {
            $geoData = Invoke-RestMethod -Uri "http://ip-api.com/json/?fields=country,countryCode,city,isp,as" -TimeoutSec 10
            Write-Host ""
            Write-Host "â”Œâ”€ Scanner Location" -ForegroundColor Yellow
            Write-Host "â”‚  Country: $($geoData.country) ($($geoData.countryCode))" -ForegroundColor Gray
            Write-Host "â”‚  City: $($geoData.city)" -ForegroundColor Gray
            Write-Host "â”‚  ISP: $($geoData.isp)" -ForegroundColor Gray
            Write-Host "â”‚  ASN: $($geoData.as)" -ForegroundColor Gray
            Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Yellow
            
            echo "runner_country=$($geoData.countryCode)" >> $env:GITHUB_OUTPUT
            echo "runner_isp=$($geoData.isp)" >> $env:GITHUB_OUTPUT
          }
          catch {
            Write-Host "Could not determine runner location" -ForegroundColor DarkGray
          }
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Network Diagnostics
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§ Pre-Scan Network Diagnostics
        run: |
          Write-Host "â”Œâ”€ Network Interfaces" -ForegroundColor Yellow
          Get-NetIPAddress -AddressFamily IPv4 | 
            Where-Object { $_.IPAddress -notlike "127.*" } | 
            Select-Object IPAddress, InterfaceAlias |
            ForEach-Object { Write-Host "â”‚  $($_.InterfaceAlias): $($_.IPAddress)" -ForegroundColor Gray }
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Yellow
          
          Write-Host ""
          Write-Host "â”Œâ”€ DNS Configuration" -ForegroundColor Yellow
          Get-DnsClientServerAddress -AddressFamily IPv4 | 
            Where-Object { $_.ServerAddresses } |
            Select-Object -First 2 |
            ForEach-Object { Write-Host "â”‚  $($_.InterfaceAlias): $($_.ServerAddresses -join ', ')" -ForegroundColor Gray }
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Yellow
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Run Scan
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Execute Network Scan
        id: scan
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘                    Starting Network Scan                          â•‘" -ForegroundColor Green
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          
          $dateFolder = Get-Date -Format "yyyy-MM-dd"
          $startTime = Get-Date
          
          # Build parameters
          $params = @()
          
          if ("${{ github.event.inputs.enable_traceroute }}" -eq "true") {
            $params += "-EnableTraceroute"
            Write-Host "âœ“ Traceroute: Enabled" -ForegroundColor Cyan
          }
          
          if ("${{ github.event.inputs.deep_scan }}" -eq "true") {
            $params += "-DeepScan"
            Write-Host "âœ“ Deep Scan: Enabled" -ForegroundColor Cyan
          }
          
          $customTargets = "${{ github.event.inputs.custom_targets }}"
          if ($customTargets) {
            $params += "-TargetsFile `"$customTargets`""
            Write-Host "âœ“ Custom Targets: $customTargets" -ForegroundColor Cyan
          }
          
          Write-Host ""
          
          # Execute scan
          try {
            $scriptPath = "${{ github.workspace }}\scripts\netcheck.ps1"
            
            if ($params.Count -gt 0) {
              $paramString = $params -join " "
              Invoke-Expression "& `"$scriptPath`" $paramString"
            } else {
              & $scriptPath
            }
            
            $scanExitCode = $LASTEXITCODE
          }
          catch {
            Write-Host "âš ï¸ Scan encountered an error: $_" -ForegroundColor Yellow
            $scanExitCode = 1
          }
          
          $endTime = Get-Date
          $duration = $endTime - $startTime
          
          Write-Host ""
          Write-Host "â”Œâ”€ Scan Complete" -ForegroundColor Yellow
          Write-Host "â”‚  Duration: $($duration.ToString('hh\:mm\:ss'))" -ForegroundColor Gray
          Write-Host "â”‚  Exit Code: $scanExitCode" -ForegroundColor Gray
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Yellow
          
          # Set outputs
          echo "scan_date=$dateFolder" >> $env:GITHUB_OUTPUT
          echo "exit_code=$scanExitCode" >> $env:GITHUB_OUTPUT
          echo "duration=$($duration.TotalSeconds)" >> $env:GITHUB_OUTPUT
        shell: pwsh
        continue-on-error: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Analyze Results
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Analyze Scan Results
        id: analyze
        run: |
          $dateFolder = "${{ steps.scan.outputs.scan_date }}"
          $summaryFile = "${{ github.workspace }}\reports\$dateFolder\summary.json"
          
          if (Test-Path $summaryFile) {
            $summary = Get-Content $summaryFile | ConvertFrom-Json
            $meta = $summary.metadata
            
            # Calculate status
            $status = "success"
            if ($meta.passRate -lt 50) { $status = "critical" }
            elseif ($meta.passRate -lt 80) { $status = "warning" }
            
            # Set outputs
            echo "pass_rate=$($meta.passRate)" >> $env:GITHUB_OUTPUT
            echo "total_targets=$($meta.totalTargets)" >> $env:GITHUB_OUTPUT
            echo "pass_count=$($meta.passCount)" >> $env:GITHUB_OUTPUT
            echo "blocked_count=$($meta.failCount)" >> $env:GITHUB_OUTPUT
            echo "avg_latency=$($meta.avgLatency)" >> $env:GITHUB_OUTPUT
            echo "scan_status=$status" >> $env:GITHUB_OUTPUT
            
            Write-Host ""
            Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
            Write-Host "â•‘                      SCAN RESULTS SUMMARY                         â•‘" -ForegroundColor Cyan
            Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
            Write-Host "â•‘  Total Targets:    $($meta.totalTargets.ToString().PadLeft(5))                                      â•‘" -ForegroundColor White
            Write-Host "â•‘  âœ… Reachable:     $($meta.passCount.ToString().PadLeft(5))                                      â•‘" -ForegroundColor Green
            Write-Host "â•‘  ğŸš« Blocked/Failed: $($meta.failCount.ToString().PadLeft(5))                                      â•‘" -ForegroundColor Red
            Write-Host "â•‘  ğŸ“Š Pass Rate:     $($meta.passRate.ToString().PadLeft(5))%                                     â•‘" -ForegroundColor Yellow
            Write-Host "â•‘  â±ï¸  Avg Latency:   $($meta.avgLatency.ToString().PadLeft(5))ms                                    â•‘" -ForegroundColor Cyan
            Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
            
            # List blocked targets
            $blocked = $summary.results | Where-Object { $_.OverallStatus -notin @("PASS") }
            if ($blocked.Count -gt 0) {
              Write-Host ""
              Write-Host "â”Œâ”€ Blocked/Failed Targets" -ForegroundColor Red
              $blocked | ForEach-Object {
                $intel = $_.Intelligence
                $loc = if ($intel.CountryCode) { "[$($intel.CountryCode)]" } else { "" }
                Write-Host "â”‚  âŒ $($_.Name) ($($_.Host)) $loc - $($_.OverallStatus)" -ForegroundColor Red
              }
              Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Red
            }
          }
          else {
            Write-Host "âš ï¸ Summary file not found" -ForegroundColor Yellow
            echo "scan_status=error" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Generate Metadata
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Generate Scan Metadata
        run: |
          $dateFolder = "${{ steps.scan.outputs.scan_date }}"
          $metaDir = "${{ github.workspace }}\reports\$dateFolder"
          
          if (-not (Test-Path $metaDir)) {
            New-Item -ItemType Directory -Path $metaDir -Force | Out-Null
          }
          
          $metadata = @{
            workflow = @{
              runId = "${{ github.run_id }}"
              runNumber = ${{ github.run_number }}
              triggeredBy = "${{ github.event_name }}"
              actor = "${{ github.actor }}"
              repository = "${{ github.repository }}"
              branch = "${{ github.ref_name }}"
              commitSha = "${{ github.sha }}"
            }
            runner = @{
              os = "${{ runner.os }}"
              arch = "${{ runner.arch }}"
            }
            scan = @{
              date = $dateFolder
              duration = "${{ steps.scan.outputs.duration }}"
              exitCode = "${{ steps.scan.outputs.exit_code }}"
              traceroute = "${{ github.event.inputs.enable_traceroute }}" -eq "true"
              deepScan = "${{ github.event.inputs.deep_scan }}" -eq "true"
            }
            timestamp = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          }
          
          $metadata | ConvertTo-Json -Depth 5 | Out-File (Join-Path $metaDir "metadata.json") -Encoding UTF8
          Write-Host "âœ“ Metadata saved" -ForegroundColor Green
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Update Pages Data
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸŒ Update GitHub Pages Data
        run: |
          $reportsDir = "${{ github.workspace }}\reports"
          $docsDir = "${{ github.workspace }}\docs"
          $dataDir = "$docsDir\data"
          
          if (-not (Test-Path $dataDir)) {
            New-Item -ItemType Directory -Path $dataDir -Force | Out-Null
          }
          
          # Find all report dates
          $reportDates = Get-ChildItem -Path $reportsDir -Directory | 
            Where-Object { $_.Name -match '^\d{4}-\d{2}-\d{2}$' } |
            Sort-Object Name -Descending |
            Select-Object -ExpandProperty Name
          
          Write-Host "Found $($reportDates.Count) historical reports" -ForegroundColor Cyan
          
          # Build history data
          $historyData = @()
          foreach ($date in $reportDates) {
            $summaryFile = Join-Path $reportsDir "$date\summary.json"
            if (Test-Path $summaryFile) {
              try {
                $summary = Get-Content $summaryFile | ConvertFrom-Json
                $historyData += @{
                  date = $date
                  totalTargets = $summary.metadata.totalTargets
                  passCount = $summary.metadata.passCount
                  failCount = $summary.metadata.failCount
                  passRate = $summary.metadata.passRate
                  avgLatency = $summary.metadata.avgLatency
                }
              }
              catch {
                Write-Host "âš ï¸ Could not parse $summaryFile" -ForegroundColor Yellow
              }
            }
          }
          
          # Save history
          $historyData | ConvertTo-Json -Depth 5 | Out-File (Join-Path $dataDir "history.json") -Encoding UTF8
          Write-Host "âœ“ History updated with $($historyData.Count) entries" -ForegroundColor Green
          
          # Copy latest summary to docs
          $latestDate = $reportDates | Select-Object -First 1
          if ($latestDate) {
            $latestSummary = Join-Path $reportsDir "$latestDate\summary.json"
            if (Test-Path $latestSummary) {
              Copy-Item $latestSummary (Join-Path $dataDir "latest.json") -Force
              Write-Host "âœ“ Latest data updated from $latestDate" -ForegroundColor Green
            }
          }
          
          # Update latest.json pointer
          @{
            date = $latestDate
            path = "reports/$latestDate"
            updated = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          } | ConvertTo-Json | Out-File (Join-Path $reportsDir "latest.json") -Encoding UTF8
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Commit Changes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ Commit Reports
        run: |
          git config user.name "FilterMapIR Bot"
          git config user.email "bot@filtermapir.github.io"
          
          git add reports/
          git add docs/data/
          
          $dateFolder = "${{ steps.scan.outputs.scan_date }}"
          $passRate = "${{ steps.analyze.outputs.pass_rate }}"
          $status = "${{ steps.analyze.outputs.scan_status }}"
          
          $statusEmoji = switch ($status) {
            "success" { "âœ…" }
            "warning" { "âš ï¸" }
            "critical" { "ğŸš¨" }
            default { "ğŸ“Š" }
          }
          
          $commitMsg = "$statusEmoji Daily Scan: $dateFolder | Pass Rate: ${passRate}%"
          
          git commit -m "$commitMsg" -m "Run ID: ${{ github.run_id }}" -m "Triggered by: ${{ github.event_name }}" || echo "No changes to commit"
          git push
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload Artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Upload Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-report-${{ steps.scan.outputs.scan_date }}
          path: |
            reports/${{ steps.scan.outputs.scan_date }}/
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Job Summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‹ Generate Job Summary
        run: |
          $dateFolder = "${{ steps.scan.outputs.scan_date }}"
          $summaryFile = "${{ github.workspace }}\reports\$dateFolder\summary.json"
          
          # Header
          echo "# ğŸ›¡ï¸ FilterMapIR Network Intelligence Report" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Date:** $dateFolder | **Run:** #${{ github.run_number }} | **Trigger:** ${{ github.event_name }}" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          if (Test-Path $summaryFile) {
            $summary = Get-Content $summaryFile | ConvertFrom-Json
            $meta = $summary.metadata
            
            # Status Badge
            $statusColor = "brightgreen"
            $statusText = "âœ… Normal"
            if ($meta.passRate -lt 50) {
              $statusColor = "red"
              $statusText = "ğŸš¨ Critical"
            }
            elseif ($meta.passRate -lt 80) {
              $statusColor = "yellow"
              $statusText = "âš ï¸ Degraded"
            }
            
            echo "## $statusText" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            
            # Stats Table
            echo "### ğŸ“Š Statistics" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $env:GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $env:GITHUB_STEP_SUMMARY
            echo "| ğŸ¯ Total Targets | **$($meta.totalTargets)** |" >> $env:GITHUB_STEP_SUMMARY
            echo "| âœ… Reachable | **$($meta.passCount)** |" >> $env:GITHUB_STEP_SUMMARY
            echo "| ğŸš« Blocked/Failed | **$($meta.failCount)** |" >> $env:GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Partial/Degraded | **$($meta.partialCount + $meta.degradedCount)** |" >> $env:GITHUB_STEP_SUMMARY
            echo "| ğŸ“ˆ Pass Rate | **$($meta.passRate)%** |" >> $env:GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Avg Latency | **$($meta.avgLatency)ms** |" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            
            # Scanner Location
            if ($summary.scannerLocation) {
              $loc = $summary.scannerLocation
              echo "### ğŸ“ Scanner Location" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $env:GITHUB_STEP_SUMMARY
              echo "| Country | $($loc.country) |" >> $env:GITHUB_STEP_SUMMARY
              echo "| ISP | $($loc.isp) |" >> $env:GITHUB_STEP_SUMMARY
              echo "| ASN | $($loc.asn) |" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
            }
            
            # Blocked Targets
            $blocked = $summary.results | Where-Object { $_.OverallStatus -notin @("PASS") }
            if ($blocked.Count -gt 0) {
              echo "### ğŸš« Blocked/Failed Targets" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "| Target | Host | Status | Location | ASN |" >> $env:GITHUB_STEP_SUMMARY
              echo "|--------|------|--------|----------|-----|" >> $env:GITHUB_STEP_SUMMARY
              
              $blocked | Select-Object -First 15 | ForEach-Object {
                $intel = $_.Intelligence
                $country = if ($intel.Country) { $intel.Country } else { "Unknown" }
                $asn = if ($intel.ASN) { $intel.ASN } else { "--" }
                echo "| $($_.Name) | ``$($_.Host)`` | $($_.OverallStatus) | $country | $asn |" >> $env:GITHUB_STEP_SUMMARY
              }
              echo "" >> $env:GITHUB_STEP_SUMMARY
            }
            
            # Passed Targets
            $passed = $summary.results | Where-Object { $_.OverallStatus -eq "PASS" }
            if ($passed.Count -gt 0) {
              echo "### âœ… Reachable Targets" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "| Target | Host | Latency | Location | ASN |" >> $env:GITHUB_STEP_SUMMARY
              echo "|--------|------|---------|----------|-----|" >> $env:GITHUB_STEP_SUMMARY
              
              $passed | Select-Object -First 10 | ForEach-Object {
                $intel = $_.Intelligence
                $latency = if ($_.Tests.Ping.AvgLatency) { "$($_.Tests.Ping.AvgLatency)ms" } else { "--" }
                $country = if ($intel.Country) { $intel.Country } else { "Unknown" }
                $asn = if ($intel.ASN) { $intel.ASN } else { "--" }
                echo "| $($_.Name) | ``$($_.Host)`` | $latency | $country | $asn |" >> $env:GITHUB_STEP_SUMMARY
              }
            }
          }
          
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "---" >> $env:GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [View Dashboard](https://${{ github.repository_owner }}.github.io/FilterMapIR/) | ğŸ“ [View Reports](https://github.com/${{ github.repository }}/tree/main/reports/$dateFolder)" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Deploy Pages (Optional - runs after scan)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pages:
    name: ğŸš€ Deploy GitHub Pages
    needs: network-scan
    runs-on: ubuntu-latest
    if: always() && needs.network-scan.result != 'cancelled'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest with commits from scan job
      
      - name: ğŸ”„ Pull Latest Changes
        run: git pull origin main
      
      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/
      
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Cleanup Old Reports
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cleanup:
    name: ğŸ§¹ Cleanup Old Reports
    needs: network-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”„ Pull Latest
        run: git pull origin main
      
      - name: ğŸ—‘ï¸ Remove Old Reports
        run: |
          cd reports
          
          # Keep only last N days of reports
          RETENTION_DAYS=${{ env.REPORT_RETENTION_DAYS }}
          CUTOFF_DATE=$(date -d "-${RETENTION_DAYS} days" +%Y-%m-%d)
          
          echo "Removing reports older than $CUTOFF_DATE..."
          
          for dir in */; do
            dir_name="${dir%/}"
            if [[ "$dir_name" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              if [[ "$dir_name" < "$CUTOFF_DATE" ]]; then
                echo "Removing old report: $dir_name"
                rm -rf "$dir_name"
              fi
            fi
          done
      
      - name: ğŸ’¾ Commit Cleanup
        run: |
          git config user.name "FilterMapIR Bot"
          git config user.email "bot@filtermapir.github.io"
          
          git add -A
          git commit -m "ğŸ§¹ Cleanup: Removed reports older than ${{ env.REPORT_RETENTION_DAYS }} days" || echo "No cleanup needed"
          git push
